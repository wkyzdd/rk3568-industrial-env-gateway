# **RK3568 工业环境监控网关 – 系统架构文档**

本项目基于 **RK3568** 实现一个完整的工业环境监控网关，包括：

- BME280 传感器数据采集
- 自研 Linux I2C 驱动
- 用户态守护进程 envd
- MQTT 上报云平台
- systemd 自动管理
- 配置文件可动态调整

本文将介绍：

1. **项目整体架构图**
2. **数据流**
3. **项目目录结构**

## 1. 项目整体架构图

```
+---------------------------------------------------------------+
|               工业环境监控网关 (基于 RK3568)                     |
+---------------------------------------------------------------+

+------------------------------------------------------------------+
|                             [云端平台]                           |
|------------------------------------------------------------------|
| - MQTT Broker（EMQX / Mosquitto）                               |
| - 数据存储/分析平台                                             |
| - 可视化大屏 / 报表                                             |
| - 告警推送                                                      |
| - 可扩展 OTA / 远程配置                                         |
+------------------------------------------------------------------+
                                ▲
                                |  MQTT / TCP/IP 网络上传
                                |
+------------------------------------------------------------------+
|                         [应用层 User Space]                     |
|                        envd 守护进程（后台服务）                |
|------------------------------------------------------------------|
|  - 周期性读取 /dev/bme280（如每 5s）                            |
|  - 加载 config.json（MQTT、阈值、采样周期）                     |
|  - 阈值判断（超温/超湿自动报警）                                |
|  - MQTT 上报数据到云端                                           |
|  - 日志记录                                                      |
+------------------------------+-----------------------------------+
                               ▲
                               |  用户态通过read() / ioctl() 调用字符设备访问数据
                               |
+------------------------------------------------------------------+
|                          [内核驱动层]                             |
|                       Linux Kernel Driver                        |
|------------------------------------------------------------------|
|   +------------------------------------------------------------+ |
|   |                      BME280 I2C 驱动                        | |
|   |                   (bme280_drv.c 自研驱动)                   | |
|   |------------------------------------------------------------| |
|   | - probe/remove                                             | |
|   | - I2C 寄存器读写                                             | |
|   | - 数据补偿算法（温/湿/压换算）                                 | |
|   | - 设备树 DTS 绑定（compatible="bosch,bme280"）               | |
|   | - 字符设备注册 → 暴露 /dev/bme280                            | |
|   +------------------------------------------------------------+ |
+------------------------------+-----------------------------------+
                               ▲
                               |  I2C 总线（硬件通讯）
                               |
+------------------------------------------------------------------+
|                          [传感器层]                             |
|                        BME280 环境传感器                        |
|------------------------------------------------------------------|
| - 采集温度                                                      |
| - 采集湿度                                                      |
| - 采集气压                                                      |
+------------------------------------------------------------------+

```

## 2. 数据流

```
传感器 → I2C → 内核驱动 → /dev/bme280 → envd → MQTT → 云端
```

含义：

- 传感器采集物理数据
- I2C 传输给 RK3568
- 驱动层执行补偿算法并提供统一接口
- envd 守护进程定时读取
- 通过 MQTT 上传云平台
- 云端展示 + 告警

## 3.项目目录结构

```
rk3568-industrial-env-gateway/
│
├── app/                            # 应用层（用户态 envd 守护进程）
│   ├── src/
│   │   ├── main.c                  # 主循环（数据采集 → MQTT → 告警）
│   │   ├── sensor_reader.c         # 读取 /dev/bme280 封装
│   │   ├── mqtt_client.c           # MQTT 通信逻辑
│   │   ├── config.c                # 加载 config.json
│   │   ├── alarm.c                 # 阈值判断
│   │   └── log.c                   # 日志模块
│   ├── include/                    # 公共头文件
│   └── Makefile                    # envd 编译脚本
│
├── build/                          # 编译产物（ko / envd / dtb），不提交 Git
│
├── config/
│   └── config.json                 # 应用运行时配置（MQTT、阈值、采样间隔）
│
├── docs/                           # 文档（架构、设计、开发记录）
│   ├── architecture.md             # 总体架构文档（你正在写）
│   ├── driver_design.md            # 驱动层设计
│   ├── app_design.md               # 应用层 envd 设计
│   └── rk3568_notes.md             # RK3568 平台开发笔记
│
├── driver/                         # Linux 内核驱动层
│   ├── src/
│   │   ├── bme280_drv.c            # 主驱动代码（probe/read/ioctl）
│   │   ├── bme280_drv.h            # 驱动内部结构体和声明
│   │   └── bme280_regs.h           # 传感器寄存器映射
│   ├── device_tree/
│   │   └── rk3568-env-bme280.dtsi  # DTS 片段（绑定 I2C 控制器）
│   ├── test/
│   │   ├── test_read.c             # 读取 /dev/bme280 的测试程序
│   │   └── Makefile
│   ├── Makefile                    # 编译 bme280_drv.ko
│   └── README.md                   # 驱动使用说明
│
├── system/                         # systemd 服务定义、部署脚本
│   ├── envd.service                # envd 守护进程的 systemd 启动文件
│   ├── install.sh                  # 自动安装驱动+应用+配置到根文件系统
│   └── uninstall.sh                # 卸载脚本
│
├── third_party/                    # 可选：第三方库（MQTT / JSON）
│
├── .gitignore                      # Git 忽略规则
├── LICENSE                         # 许可证
└── README.md                       # 项目总览说明（GitHub 首页）
```

